/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP AG or an SAP affiliate company. 
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
jQuery.sap.declare("sap.ui.table.AnalyticalTable");jQuery.sap.require("sap.ui.table.library");jQuery.sap.require("sap.ui.table.Table");sap.ui.table.Table.extend("sap.ui.table.AnalyticalTable",{metadata:{publicMethods:["getTotalSize"],library:"sap.ui.table",properties:{"sumOnTop":{type:"boolean",group:"Appearance",defaultValue:false},"numberOfExpandedLevels":{type:"int",group:"Misc",defaultValue:0},"columnVisibilityMenuSorter":{type:"any",group:"Appearance",defaultValue:null},"dirty":{type:"boolean",group:"Appearance",defaultValue:null,deprecated:true}}}});jQuery.sap.require("sap.ui.model.analytics.TreeBindingAdapter");jQuery.sap.require("sap.ui.table.AnalyticalColumn");
sap.ui.table.AnalyticalTable.prototype.init=function(){sap.ui.table.Table.prototype.init.apply(this,arguments);this.addStyleClass("sapUiAnalyticalTable");this.attachBrowserEvent("contextmenu",this._onContextMenu);this.setSelectionMode(sap.ui.table.SelectionMode.MultiToggle);this.setShowColumnVisibilityMenu(true);this.setEnableColumnFreeze(true);this.setEnableCellFilter(true);this._aGroupedColumns=[];if(sap.ui.getCore().getConfiguration().getTheme()==="sap_bluecrystal"){jQuery.sap.require("sap.ui.core.IconPool");sap.ui.core.IconPool.insertFontFaceStyle();this.setRowHeight(32)}};
sap.ui.table.AnalyticalTable.prototype.setFixedRowCount=function(){jQuery.sap.log.error("The property fixedRowCount is not supported by the AnalyticalTable and must not be set!");return this};
sap.ui.table.AnalyticalTable.prototype.setFixedBottomRowCount=function(){jQuery.sap.log.error("The property fixedBottomRowCount is managed by the AnalyticalTable and must not be set!");return this};
sap.ui.table.AnalyticalTable.prototype.onAfterRendering=function(){sap.ui.table.Table.prototype.onAfterRendering.apply(this,arguments);this.$().find("[role=grid]").attr("role","treegrid")};
sap.ui.table.AnalyticalTable.prototype.setDirty=function(d){jQuery.sap.log.error("The property \"dirty\" is deprecated. Please use \"showOverlay\".");this.setProperty("dirty",d,true);this.setShowOverlay(this.getDirty());return this};
sap.ui.table.AnalyticalTable.prototype.getModel=function(m,n){var m=sap.ui.table.Table.prototype.getModel.apply(this,arguments);if(m&&sap.ui.model.odata&&m instanceof sap.ui.model.odata.ODataModel){jQuery.sap.require("sap.ui.model.analytics.ODataModelAdapter");sap.ui.model.analytics.ODataModelAdapter.apply(m)}return m};
sap.ui.table.AnalyticalTable.prototype._bindAggregation=function(n,p,t,s,f){if(n==="rows"){this.setProperty("firstVisibleRow",0,true)}return sap.ui.table.Table.prototype._bindAggregation.apply(this,arguments)};
sap.ui.table.AnalyticalTable.prototype.bindRows=function(b){var p,t,s,f;if(typeof b=="string"){p=arguments[0];t=arguments[1];s=arguments[2];f=arguments[3];b={path:p,sorter:s,filters:f};if(t instanceof sap.ui.base.ManagedObject){b.template=t}else if(typeof t==="function"){b.factory=t}}var c=this.getColumns();for(var i=0,l=c.length;i<l;i++){if(c[i].getSorted()){b.sorter=b.sorter||[];b.sorter.push(new sap.ui.model.Sorter(c[i].getSortProperty()||c[i].getLeadingProperty(),c[i].getSortOrder()===sap.ui.table.SortOrder.Descending))}}b.parameters=b.parameters||{};b.parameters.analyticalInfo=this._getColumnInformation();b.parameters.sumOnTop=this.getSumOnTop();b.parameters.numberOfExpandedLevels=this.getNumberOfExpandedLevels();var r=this.bindAggregation("rows",b);this._bSupressRefresh=true;this._updateColumns();this._bSupressRefresh=false;return r};
sap.ui.table.AnalyticalTable.prototype._getColumnInformation=function(){var c=[],t=this.getColumns();for(var i=0;i<this._aGroupedColumns.length;i++){var C=sap.ui.getCore().byId(this._aGroupedColumns[i]);if(!C)continue;c.push({name:C.getLeadingProperty(),visible:C.getVisible(),grouped:C.getGrouped(),total:C.getSummed(),sorted:C.getSorted(),sortOrder:C.getSortOrder(),inResult:C.getInResult(),formatter:C.getGroupHeaderFormatter()})}for(var i=0;i<t.length;i++){var C=t[i];if(jQuery.inArray(C.getId(),this._aGroupedColumns)>-1){continue}if(!C instanceof sap.ui.table.AnalyticalColumn){jQuery.sap.log.error("You have to use AnalyticalColumns for the Analytical table")}c.push({name:C.getLeadingProperty(),visible:C.getVisible(),grouped:C.getGrouped(),total:C.getSummed(),sorted:C.getSorted(),sortOrder:C.getSortOrder(),inResult:C.getInResult(),formatter:C.getGroupHeaderFormatter()})}return c};
sap.ui.table.AnalyticalTable.prototype._updateTableContent=function(){sap.ui.table.Table.prototype._updateTableContent.apply(this,arguments);var b=this.getBinding("rows"),f=this.getFirstVisibleRow(),F=this.getFixedBottomRowCount(),c=this.getVisibleRowCount();if(!b){return}var i=this._getFirstMeasureColumnIndex(),m;if(i>-1){var h=this.getSelectionMode()!==sap.ui.table.SelectionMode.None&&this.getSelectionBehavior()!==sap.ui.table.SelectionBehavior.RowOnly;var $=this.$().find(".sapUiTableCtrlFirstCol > th");if(h){$=$.not(":nth-child(1)")}var o=$.get(0).getBoundingClientRect().left;var M=32+$.get(this._getFirstMeasureColumnIndex()).getBoundingClientRect().left-o;m=M+"px"}else{m="none"}for(var r=0;r<c;r++){var I=r>(c-F-1)&&b.getLength()>c,R=I?(b.getLength()-1-(c-1-r)):f+r,C=this.getContextInfoByIndex(R),a=this.getRows()[r],d=a.$(),e=a.$("fixed"),g=this.$().find("div[data-sap-ui-rowindex="+d.attr("data-sap-ui-rowindex")+"]"),l=C?C.level:0;if(!C||!C.context){d.removeAttr("data-sap-ui-level");d.removeAttr('aria-level');d.removeAttr('aria-expanded');d.removeClass("sapUiTableGroupHeader");d.removeClass("sapUiAnalyticalTableSum");d.removeClass("sapUiAnalyticalTableDummy");e.removeAttr("data-sap-ui-level");e.removeAttr('aria-level');e.removeAttr('aria-expanded');e.removeClass("sapUiTableGroupHeader");g.removeClass("sapUiTableGroupHeader");g.html("");g.removeAttr("data-sap-ui-level");g.removeClass("sapUiAnalyticalTableSum");g.removeClass("sapUiAnalyticalTableDummy");if(C&&!C.context){d.addClass("sapUiAnalyticalTableDummy");g.addClass("sapUiAnalyticalTableDummy");g.html('<div class="sapUiAnalyticalTableLoading">Loading...</div>')}continue}if(b.indexHasChildren&&b.indexHasChildren(R)){d.addClass("sapUiTableGroupHeader");e.addClass("sapUiTableGroupHeader");var s=C.expanded?"sapUiTableGroupIconOpen":"sapUiTableGroupIconClosed";d.attr('aria-expanded',C.expanded);e.attr('aria-expanded',C.expanded);var G=b.getGroupName(C.context,C.level);g.html("<div class=\"sapUiTableGroupIcon "+s+"\" tabindex=\"-1\" title=\""+G+"\" style=\"max-width:"+m+"\">"+G+"</div>");if(C.expanded&&!this.getSumOnTop()){d.addClass("sapUiTableRowHidden")}d.removeClass("sapUiAnalyticalTableSum");g.removeClass("sapUiAnalyticalTableSum");d.removeClass("sapUiAnalyticalTableDummy");g.removeClass("sapUiAnalyticalTableDummy");g.addClass("sapUiTableGroupHeader").removeAttr("title")}else{d.attr('aria-expanded',false);d.removeClass("sapUiTableGroupHeader");d.removeClass("sapUiTableRowHidden");d.removeClass("sapUiAnalyticalTableSum");d.removeClass("sapUiAnalyticalTableDummy");e.attr('aria-expanded',false);e.removeClass("sapUiTableGroupHeader");g.html("");g.removeClass("sapUiTableGroupHeader");g.removeClass("sapUiAnalyticalTableDummy");g.removeClass("sapUiAnalyticalTableSum");if(C.sum&&C.context&&C.context.getObject()){d.addClass("sapUiAnalyticalTableSum");g.addClass("sapUiAnalyticalTableSum")}}d.attr("data-sap-ui-level",l);e.attr("data-sap-ui-level",l);g.attr("data-sap-ui-level",l);d.attr('aria-level',l+1);e.attr('aria-level',l+1)}};
sap.ui.table.AnalyticalTable.prototype.onclick=function(e){if(jQuery(e.target).hasClass("sapUiTableGroupIcon")){this._onNodeSelect(e)}else if(jQuery(e.target).hasClass("sapUiAnalyticalTableSum")){e.preventDefault();return}else{if(sap.ui.table.Table.prototype.onclick){sap.ui.table.Table.prototype.onclick.apply(this,arguments)}}};
sap.ui.table.AnalyticalTable.prototype.onsapselect=function(e){if(jQuery(e.target).hasClass("sapUiTableGroupIcon")){this._onNodeSelect(e)}else if(jQuery(e.target).hasClass("sapUiAnalyticalTableSum")){e.preventDefault();return}else{var t=jQuery(e.target),T=t.closest('div.sapUiTableRowHdr');if(T.hasClass('sapUiTableGroupHeader')&&T.hasClass('sapUiTableRowHdr')){var r=this.getFirstVisibleRow()+parseInt(T.attr("data-sap-ui-rowindex"),10);var b=this.getBinding("rows"),c=b.getContextInfo(r);if(c.childCount>0){this._oSelection.sliceSelectionInterval(r+1,Math.max(r+1,r+c.childCount))}b.toggleIndex(r);this.updateRows();return}if(sap.ui.table.Table.prototype.onsapselect){sap.ui.table.Table.prototype.onsapselect.apply(this,arguments)}}};
sap.ui.table.AnalyticalTable.prototype._onNodeSelect=function(e){var $=jQuery(e.target).parent();if($.length>0){var r=this.getFirstVisibleRow()+parseInt($.attr("data-sap-ui-rowindex"),10);var b=this.getBinding("rows"),c=b.getContextInfo(r);if(c.childCount>0){this._oSelection.sliceSelectionInterval(r+1,Math.max(r+1,r+c.childCount))}b.toggleIndex(r);this.updateRows()}e.preventDefault();e.stopPropagation()};
sap.ui.table.AnalyticalTable.prototype._onContextMenu=function(e){if(jQuery(e.target).closest('tr').hasClass('sapUiTableGroupHeader')||jQuery(e.target).closest('.sapUiTableRowHdr.sapUiTableGroupHeader').length>0){this._iGroupedLevel=jQuery(e.target).closest('[data-sap-ui-level]').data('sap-ui-level');var m=this._getGroupHeaderMenu();var a=sap.ui.core.Popup.Dock;m.open(false,e.target,a.LeftTop,a.LeftTop,document,(e.pageX-2)+" "+(e.pageY-2));e.preventDefault();e.stopPropagation();return}return true};
sap.ui.table.AnalyticalTable.prototype._getGroupHeaderMenu=function(){var t=this;function g(){var C=t.getColumns(),f=0,c;for(var i=0;i<C.length;i++){c=C[i];if(c.getGrouped()){f++;if(f==t._iGroupedLevel){return{column:c,index:i}}}}return undefined}if(!this._oGroupHeaderMenu){this._oGroupHeaderMenu=new sap.ui.unified.Menu();this._oGroupHeaderMenuVisibilityItem=new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_SHOW_COLUMN"),select:function(){var G=g();if(G){var c=G.column;c.setShowIfGrouped(!c.getShowIfGrouped())}}});this._oGroupHeaderMenu.addItem(this._oGroupHeaderMenuVisibilityItem);this._oGroupHeaderMenu.addItem(new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_UNGROUP"),select:function(){var C=t.getColumns(),f=0,l=-1,u=-1,c;for(var i=0;i<C.length;i++){c=C[i];if(c.getGrouped()){f++;if(f==t._iGroupedLevel){c._bSkipUpdateAI=true;c.setGrouped(false);c._bSkipUpdateAI=false;u=i}else{l=i}}}if(l>-1&&u>-1&&u<l){var U=C[u];var h=U.getHeaderSpan();if(jQuery.isArray(h)){h=h[0]}var r=[];for(var i=u;i<u+h;i++){r.push(C[i])}jQuery.each(r,function(I,c){t.removeColumn(c);t.insertColumn(c,l)})}t._updateTableColumnDetails();t.updateAnalyticalInfo()}}));this._oGroupHeaderMenu.addItem(new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_UNGROUP_ALL"),select:function(){var C=t.getColumns();for(var i=0;i<C.length;i++){C[i]._bSkipUpdateAI=true;C[i].setGrouped(false);C[i]._bSkipUpdateAI=false}t._bSupressRefresh=true;t._updateTableColumnDetails();t.updateAnalyticalInfo();t._bSupressRefresh=false}}));this._oGroupHeaderMoveUpItem=new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_MOVE_UP"),select:function(){var G=g();if(G){var c=G.column;var i=jQuery.inArray(c.getId(),t._aGroupedColumns);if(i>0){t._aGroupedColumns[i]=t._aGroupedColumns.splice(i-1,1,t._aGroupedColumns[i])[0];t.updateAnalyticalInfo()}}},icon:"sap-icon://arrow-top"});this._oGroupHeaderMenu.addItem(this._oGroupHeaderMoveUpItem);this._oGroupHeaderMoveDownItem=new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_MOVE_DOWN"),select:function(){var G=g();if(G){var c=G.column;var i=jQuery.inArray(c.getId(),t._aGroupedColumns);if(i<t._aGroupedColumns.length){t._aGroupedColumns[i]=t._aGroupedColumns.splice(i+1,1,t._aGroupedColumns[i])[0];t.updateAnalyticalInfo()}}},icon:"sap-icon://arrow-bottom"});this._oGroupHeaderMenu.addItem(this._oGroupHeaderMoveDownItem);this._oGroupHeaderMenu.addItem(new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_SORT_ASC"),select:function(){var G=g();if(G){var c=G.column;c.sort(false)}},icon:"sap-icon://up"}));this._oGroupHeaderMenu.addItem(new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_SORT_DESC"),select:function(){var G=g();if(G){var c=G.column;c.sort(true)}},icon:"sap-icon://down"}));this._oGroupHeaderMenu.addItem(new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_COLLAPSE_LEVEL"),select:function(){t.getBinding("rows").collapseAll(t._iGroupedLevel);t._oSelection.clearSelection();t.updateRows()}}));this._oGroupHeaderMenu.addItem(new sap.ui.unified.MenuItem({text:this._oResBundle.getText("TBL_COLLAPSE_ALL"),select:function(){t.getBinding("rows").collapseAll();t._oSelection.clearSelection();t.updateRows()}}))}var G=g();if(G){var c=G.column;if(c.getShowIfGrouped()){this._oGroupHeaderMenuVisibilityItem.setText(this._oResBundle.getText("TBL_HIDE_COLUMN"))}else{this._oGroupHeaderMenuVisibilityItem.setText(this._oResBundle.getText("TBL_SHOW_COLUMN"))}this._oGroupHeaderMoveUpItem.setEnabled(G.index>0);this._oGroupHeaderMoveDownItem.setEnabled(G.index<this._aGroupedColumns.length-2)}else{this._oGroupHeaderMoveUpItem.setEnabled(true);this._oGroupHeaderMoveDownItem.setEnabled(true)}return this._oGroupHeaderMenu};
sap.ui.table.AnalyticalTable.prototype.expand=function(r){var b=this.getBinding("rows");if(b){var c=this.getContextByIndex(r);b.expand(c);this.updateRows()}};
sap.ui.table.AnalyticalTable.prototype.collapse=function(r){var b=this.getBinding("rows");if(b){var c=this.getContextByIndex(r);var C=b.getContextInfo(r);if(C.childCount>0){this._oSelection.sliceSelectionInterval(r+1,r+1+C.childCount)}b.collapse(c);this.updateRows()}};
sap.ui.table.AnalyticalTable.prototype.isExpanded=function(r){var b=this.getBinding("rows");if(b){var c=this.getContextByIndex(r);return b.isExpanded(c)}return false};
sap.ui.table.AnalyticalTable.prototype.getContextInfoByIndex=function(i){var b=this.getBinding("rows");return i>=0&&b?b.getContextInfo(i):null};
sap.ui.table.AnalyticalTable.prototype._onColumnMoved=function(e){sap.ui.table.Table.prototype._onColumnMoved.apply(this,arguments);this.updateAnalyticalInfo()};
sap.ui.table.AnalyticalTable.prototype.addColumn=function(c,s){var C=this._getColumn(c);if(C.getGrouped()){this._aGroupedColumns.push(C.getId())}return sap.ui.table.Table.prototype.addColumn.call(this,C,s)};
sap.ui.table.AnalyticalTable.prototype.insertColumn=function(c,i,s){var C=this._getColumn(c);if(C.getGrouped()){this._aGroupedColumns.push(C.getId())}return sap.ui.table.Table.prototype.insertColumn.call(this,C,i,s)};
sap.ui.table.AnalyticalTable.prototype.removeColumn=function(c,s){var C=sap.ui.table.Table.prototype.removeColumn.apply(this,arguments);if(C){this._aGroupedColumns=jQuery.grep(this._aGroupedColumns,function(v){return v!=C.getId()})}return C};
sap.ui.table.AnalyticalTable.prototype.removeAllColumns=function(s){this._aGroupedColumns=[];return sap.ui.table.Table.prototype.removeColumn.apply(this,arguments)};
sap.ui.table.AnalyticalTable.prototype._getColumn=function(c){if(typeof c==="string"){var C=new sap.ui.table.AnalyticalColumn({leadingProperty:c,template:c,managed:true});var m=this.getModel();if(m){this._updateColumn(C)}return C}else if(c instanceof sap.ui.table.AnalyticalColumn){return c}else{throw new Error("Wrong column type. You need to define a string (property) or pass an AnalyticalColumnObject")}};
sap.ui.table.AnalyticalTable.prototype._updateColumns=function(){var t=this;jQuery.each(this.getColumns(),function(i,c){c._bSkipUpdateAI=true;t._updateColumn(c);c._bSkipUpdateAI=false});this._updateTableColumnDetails();this.updateAnalyticalInfo()};
sap.ui.table.AnalyticalTable.prototype._updateColumn=function(c){var l=c.getLeadingProperty(),b=this.getBinding("rows"),r=b&&b.getAnalyticalQueryResult(),e=r&&r.getEntityType(),f=e&&e.getFilterablePropertyNames(),s=e&&e.getSortablePropertyNames(),p=e&&e.getProperties();if(jQuery.inArray(l,f)>-1){c.setFilterProperty(l)}else{c.setFilterProperty("")}if(jQuery.inArray(l,s)>-1){c.setSortProperty(l)}else{c.setSortProperty("")}var P=p&&p[l];if(P){var t=undefined;switch(P.type){case"Edm.Time":t="sap.ui.model.type.Time";break;case"Edm.DateTime":case"Edm.DateTimeOffset":t="sap.ui.model.type.DateTime";break;case"Edm.Single":case"Edm.Double":case"Edm.Decimal":t="sap.ui.model.type.Float";break;case"Edm.SByte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":t="sap.ui.model.type.Integer";break;case"Edm.Boolean":t="sap.ui.model.type.Boolean";break}c.setFilterType(t)}else{c.setFilterType(undefined)}};
sap.ui.table.AnalyticalTable.prototype.updateAnalyticalInfo=function(s){var b=this.getBinding("rows");if(b){var c=this._getColumnInformation();b.updateAnalyticalInfo(c);this._updateTotalRow(c,true);if(s||this._bSupressRefresh){return}this.refreshRows()}};
sap.ui.table.AnalyticalTable.prototype._updateTotalRow=function(c,s){var h=false;for(var i=0,l=c?c.length:0;i<l;i++){if(c[i].total){h=true;break}}var b=this.getBinding("rows");if(b&&!b.bProvideGrandTotals){h=false}if(h){this.setProperty("fixedBottomRowCount",1,s)}else{this.setProperty("fixedBottomRowCount",0,s)}};
sap.ui.table.AnalyticalTable.prototype._updateTableColumnDetails=function(){var b=this.getBinding("rows"),r=b&&b.getAnalyticalQueryResult();if(r){var c=this.getColumns(),C=c.length,l=false,g=[],G=0,a=0,o,d,D;for(var i=C-1;i>=0;i--){o=c[i];o._isLastGroupableLeft=false;o._bLastGroupAndGrouped=false;o._bDependendGrouped=false;if(!o.getVisible()){continue}d=r.findDimensionByPropertyName(o.getLeadingProperty());if(d){a++;if(o.getGrouped()){g[i]=d;G++}}if(!l&&d){if(o.getGrouped()){o._bLastGroupAndGrouped=true}l=true}}for(var i=C-1;i>=0;i--){o=c[i];if(!o.getVisible()){continue}d=r.findDimensionByPropertyName(o.getLeadingProperty());D=jQuery.inArray(d,g);if(D>-1&&D!=i&&!o._bLastGroupAndGrouped){o._bDependendGrouped=true}if(d&&!o.getGrouped()&&o.getVisible()&&G+1==a){o._isLastGroupableLeft=true}}}};
sap.ui.table.AnalyticalTable.prototype._getFirstMeasureColumnIndex=function(){var b=this.getBinding("rows"),r=b&&b.getAnalyticalQueryResult(),c=this._getVisibleColumns();if(!r){return-1}for(var i=0;i<c.length;i++){var C=c[i],l=C.getLeadingProperty();if(r.findMeasureByName(l)||r.findMeasureByPropertyName(l)){return i}}};
sap.ui.table.AnalyticalTable.prototype.getTotalSize=function(){var b=this.getBinding("rows");if(b){return b.getTotalSize()}return 0};
sap.ui.table.AnalyticalTable.prototype._onPersoApplied=function(){sap.ui.table.Table.prototype._onPersoApplied.apply(this,arguments);this._aGroupedColumns=[];var c=this.getColumns();for(var i=0,l=c.length;i<l;i++){if(c[i].getGrouped()){this._aGroupedColumns.push(c[i].getId())}}this._updateTableColumnDetails();this.updateAnalyticalInfo()};
